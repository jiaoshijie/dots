#!/usr/bin/env bash

ifinstalled "xwallpaper" || exit

change_background() {
  if [ -e "$1" ] && [ -f "$1" ]; then
    img_name=$(basename "$1")
    [ "$img_name" == "jsj_wallpaper_set-bg" ] || cp -f "$1" "$HOME"/.cache/jsj_wallpaper_set-bg
    if ! xwallpaper --zoom "$HOME"/.cache/jsj_wallpaper_set-bg > /dev/null 2>&1; then
      echo "The file must be a image file."
    fi
  else
    echo "The file isn't exist, or it's not a file."
  fi
}

regularly_change_background() {
  Index=(1 1 1 1 1 1 2 2 3 4 5 6 7 8 9 10 11 12 13 14 15 15 16 16)
  while true; do
    change_background "$HOME/media/wallpaper/01_Mojave/mojave_dynamic_${Index[$(date '+%_H')]}.jpeg"
    (( wa=60-$(date '+%_M') ))
    sleep $wa"m"
  done
}

main() {
  if test -n "$1"; then
    if [[ "$1" == "-r" ]]; then
      regularly_change_background
    else
      change_background "$1"
    fi
  else
    # random choose a image sets as wallpaper
    img_dir=$HOME/media/wallpaper/02_wallpapers
    # https://unix.stackexchange.com/questions/15308/how-to-use-find-command-to-search-for-multiple-extensions#15309
    img=$(find "$img_dir" -type f \( -name '*.jpg' -o -name '*.png' -o -name '*jpeg' \) | shuf | tail -n 1)
    change_background "$img"
  fi
}

main "$@"
